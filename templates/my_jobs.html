{% extends 'base.html' %}

{% block title %}My Jobs - HireHub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">My Posted Jobs</h2>

        <div id="loading" class="text-center">
            <div class="spinner-border" role="status"></div>
        </div>

        <div id="jobs-container">
            <!-- Jobs will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check if user is employer
    const role = localStorage.getItem('user_role');
    if (role !== 'employer') {
        alert('Only employers can view this page');
        window.location.href = '/';
    }

    async function loadMyJobs() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('Please login first');
            window.location.href = '/login/';
            return;
        }

        try {
            const response = await fetch('http://127.0.0.1:8000/api/jobs/my-jobs/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const jobs = await response.json();

            document.getElementById('loading').style.display = 'none';
            const container = document.getElementById('jobs-container');
            container.innerHTML = '';

            if (jobs.length === 0) {
                container.innerHTML = '<p>You haven\'t posted any jobs yet. <a href="/post-job/">Post your first job</a></p>';
                return;
            }

            jobs.forEach(job => {
                const jobCard = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5>${job.title}</h5>
                                    <p class="text-muted">${job.company_name} - ${job.location}</p>
                                    <p><strong>Type:</strong> ${job.job_type} | <strong>Salary:</strong> ${job.salary}</p>
                                    <p><small>Posted: ${new Date(job.posted_date).toLocaleDateString()}</small></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-info" onclick="viewApplications(${job.id})">View Applications</button>
                                    <a href="/job/${job.id}/" class="btn btn-sm btn-primary">View</a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteJob(${job.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += jobCard;
            });

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').innerHTML = '<p class="text-danger">Error loading jobs.</p>';
        }
    }

    async function deleteJob(jobId) {
        if (!confirm('Are you sure you want to delete this job?')) {
            return;
        }

        const token = localStorage.getItem('access_token');

        try {
            const response = await fetch(`http://127.0.0.1:8000/api/jobs/${jobId}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                alert('Job deleted successfully');
                loadMyJobs();
            } else {
                alert('Failed to delete job');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
    }

    function viewApplications(jobId) {
        // This would open a modal or redirect to applications page
        alert(`View applications for job ID: ${jobId}\n\nImplement this by fetching from: /api/applications/job/${jobId}/`);
    }

    loadMyJobs();
</script>
{% endblock %}
